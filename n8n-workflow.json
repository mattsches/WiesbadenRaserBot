{
  "name": "WiesbadenRaserBot",
  "nodes": [
    {
      "parameters": {},
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [
        240,
        150
      ]
    },
    {
      "parameters": {
        "url": "https://traffic.ls.hereapi.com/traffic/6.3/flow.json?bbox=50.1097,8.1922;50.0466,8.2781&apiKey=<YOUR_API_KEY>",
        "options": {}
      },
      "name": "Here Traffic Flow Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        500,
        300
      ]
    },
    {
      "parameters": {
        "interval": 10,
        "unit": "minutes"
      },
      "name": "Interval",
      "type": "n8n-nodes-base.interval",
      "typeVersion": 1,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "const SPEED_LIMIT = 55;\nconst CONFIDENCE_LIMIT = 0.7;\nconst dateTimeOptions = {\n    timeZone: \"Europe/Berlin\",\n    hour: \"numeric\",\n    minute: \"numeric\",\n    day: \"numeric\",\n    month: \"numeric\",\n    year: \"numeric\"\n}\n\nconst rules = {\n    \"D01+50414\": { // B54 Berliner Stra√üe, 1. Ring, Aarstra√üe\n        24314: null,\n        37120: null,\n        24315: \"1. Ring zwischen Berliner Stra√üe und Mainzer Stra√üe\",\n        37121: \"1. Ring zwischen Mainzer Stra√üe und Biebricher Allee\",\n        24316: \"1. Ring zwischen Biebricher Allee und Schiersteiner Stra√üe\",\n        36710: \"1. Ring zwischen Schiersteiner Stra√üe und Ringkirche\",\n        37122: \"1. Ring zwischen Ringkirche und Sedanplatz\",\n        37123: \"Seerobenstra√üe zwischen Sedanplatz und D√ºrerplatz\",\n        36347: null,\n    },\n    \"D01-50414\": { // B54 Aarstra√üe, 1. Ring, Berliner Stra√üe\n        24314: null,\n        37120: \"1. Ring zwischen Mainzer Stra√üe und Berliner Stra√üe\",\n        24315: \"1. Ring zwischen Biebricher Allee und Mainzer Stra√üe\",\n        37121: \"1. Ring zwischen Schiersteiner Stra√üe und Biebricher Allee\",\n        24316: \"1. Ring zwischen Ringkirche und Schiersteiner Stra√üe\",\n        36710: \"1. Ring zwischen Sedanplatz und Ringkirche\",\n        37122: \"Seerobenstra√üe zwischen D√ºrerplatz und Sedanplatz\",\n        37123: null,\n        36347: null,\n    },\n    \"D01+50529\": { // B417 stadtausw√§rts\n        37381: null,\n        37036: \"Unter den Eichen/Sch√ºtzenstra√üe/D√ºrer-Stra√üe Richtung Nordfriedhof\",\n        26094: null\n    },\n    \"D01-50529\": { // B417 stadteinw√§rts\n        37381: null,\n        37036: null,\n        26094: \"Unter den Eichen/Sch√ºtzenstra√üe/D√ºrer-Stra√üe Richtung D√ºrerplatz\"\n    },\n    \"D01+37364\": { // B263 Mainzer Stra√üe stadtausw√§rts\n        37365: null,\n        37366: \"Mainzer Stra√üe zwischen 1. Ring und 2. Ring\",\n        37367: null\n    },\n    \"D01-37364\": { // B263 Mainzer Stra√üe stadteinw√§rts\n        37365: \"Mainzer Stra√üe zwischen 2. Ring und 1. Ring\",\n        37366: \"Mainzer Stra√üe zwischen A66 und 2. Ring\",\n        37367: null\n    },\n    \"D01+36353\": { // 2. Ring D√ºrerplatz -> Biebricher Allee\n        36354: \"2. Ring zwischen D√ºrerplatz und Waterloostra√üe\",\n        36355: \"2. Ring zwischen Waterloostra√üe und Klarenthaler Stra√üe\",\n        36356: \"2. Ring zwischen Klarenthaler Stra√üe und Dotzheimer Stra√üe\",\n        36357: \"2. Ring zwischen Dotzheimer Stra√üe und Schiersteiner Stra√üe\",\n        36358: \"2. Ring zwischen Schiersteiner Stra√üe und Biebricher Allee\",\n    },\n    \"D01-36353\": { // 2. Ring Biebricher Allee -> D√ºrerplatz\n        36354: \"2. Ring zwischen Klarenthaler Stra√üe und D√ºrerplatz\",\n        36355: \"2. Ring zwischen Dotzheimer Stra√üe und Klarenthaler Stra√üe\",\n        36356: \"2. Ring zwischen Schiersteiner Stra√üe und Dotzheimer Stra√üe\",\n        36357: \"2. Ring zwischen Biebricher Allee und Schiersteiner Stra√üe\",\n        36358: null,\n    },\n    \"D01+36343\": { // Schiersteiner Stra√üe stadteinw√§rts\n        36344: null,\n        36345: \"Schiersteiner Stra√üe zwischen Waldstra√üe und 2. Ring\",\n        36346: \"Schiersteiner Stra√üe zwischen 2. Ring und 1. Ring\",\n    },\n    \"D01-36343\": { // Schiersteiner Stra√üe stadtausw√§rts\n        36344: \"Schiersteiner Stra√üe zwischen 2. Ring und Waldstra√üe\",\n        36345: \"Schiersteiner Stra√üe zwischen 1. Ring und 2. Ring\",\n        36346: null,\n    },\n    \"D01+36317\": { // Biebricher Allee stadtausw√§rts\n        36318: null,\n        36319: \"Biebricher Allee zwischen 1. Ring und 2. Ring\",\n        36320: \"Biebricher Allee zwischen 2. Ring und A66\",\n    },\n    \"D01-36317\": { // Biebricher Allee stadteinw√§rts\n        36318: \"Biebricher Allee zwischen 2. Ring und 1. Ring\",\n        36319: \"Biebricher Allee zwischen A66 und 2. Ring\",\n        36320: \"Biebricher Allee zwischen √Ñppelallee und A66\",\n    },\n    \"D01+36323\": { //\"K647\" West -> Ost\n        36324: null,\n        36325: \"Lahnstra√üe zwischen D√ºrerplatz und Klarenthaler Stra√üe\",\n        36326: \"Emser Stra√üe zwischen D√ºrerplatz und Schwalbacher Stra√üe\",\n        36327: \"Webergasse/Coulinstra√üe zwischen Schwalbacher Stra√üe und Wilhelmstra√üe\",\n        36328: \"Wilhelmstra√üe zwischen Staatstheater und Kureck\",\n        36329: \"Sonnenberger Stra√üe zwischen Wilhelmstra√üe und In der Dietenm√ºhle\",\n        36330: \"Danziger Stra√üe zwischen In der Dietenm√ºhle und Sonnenberg\",\n    },\n    \"D01-36323\": { //\"K647\" Ost -> West\n        36324: \"Lahnstra√üe zwischen D√ºrerplatz und Klarenthaler Stra√üe\",\n        36325: \"Emser Stra√üe zwischen Schwalbacher Stra√üe und D√ºrerplatz\",\n        36326: \"Webergasse/Coulinstra√üe zwischen Wilhelmstra√üe und Schwalbacher Stra√üe\",\n        36327: \"Wilhelmstra√üe zwischen Kureck und Staatstheater\",\n        36328: \"Sonnenberger Stra√üe zwischen In der Dietenm√ºhle und Wilhelmstra√üe\",\n        36329: \"Danziger Stra√üe zwischen Sonnenberg und In der Dietenm√ºhle\",\n        36330: null,\n    },\n    \"D01-37369\": { //\"L3037\" Ost -> West\n        37373: \"Klarenthaler Stra√üe zwischen 2. Ring und Lahnstra√üe\",\n        37374: \"Klarenthaler Stra√üe zwischen Ringkirche und 2. Ring\",\n        37375: \"Rheinstra√üe zwischen Oranienstra√üe und Ringkirche\",\n        37376: \"Rheinstra√üe zwischen Friedrich-Ebert-Allee und Oranienstra√üe\",\n        37377: \"Rheinstra√üe zwischen Frankfurter Stra√üe und Friedrich-Ebert-Allee\",\n        37378: \"Frankfurter Stra√üe zwischen Stadion und Rheinstra√üe\",\n        37379: null,\n        37380: null,\n    },\n    \"D01+37369\": { //\"L3037\" West -> Ost\n        37373: null,\n        37374: \"Klarenthaler Stra√üe zwischen Lahnstra√üe und 2. Ring\",\n        37375: \"Klarenthaler Stra√üe zwischen 2. Ring und Ringkirche\",\n        37376: \"Rheinstra√üe zwischen Ringkirche und Oranienstra√üe\",\n        37377: \"Rheinstra√üe zwischen Oranienstra√üe und Friedrich-Ebert-Allee\",\n        37378: \"Rheinstra√üe zwischen Friedrich-Ebert-Allee und Frankfurter Stra√üe\",\n        37379: \"Frankfurter Stra√üe zwischen Rheinstra√üe und Stadion\",\n        37380: null,\n    },\n}\n\nfunction isValid(roadWay, flowItem) {\n    if (!Object.keys(flowItem.CF[0]).includes(\"SU\")) {\n        return false;\n    }\n    if (flowItem.CF[0].SU <= SPEED_LIMIT) {\n        return false;\n    }\n    if (flowItem.CF[0].CN <= CONFIDENCE_LIMIT) {\n        return false;\n    }\n    if (!Object.keys(rules).includes(roadWay.LI)) {\n        console.log('Unknown/excluded road ' + roadWay.LI);\n        return false;\n    }\n    if (rules[roadWay.LI][flowItem.TMC.PC] === undefined || rules[roadWay.LI][flowItem.TMC.PC] === null) {\n        console.log('Unknown/excluded segment ' + roadWay.LI + '/' + flowItem.TMC.PC);\n        return false;\n    }\n    return true;\n}\n\nlet data = [];\nfor (let roadWay of items[0].json.RWS[0].RW) {\n    for (let flowItem of roadWay.FIS[0].FI) {\n        if (!isValid(roadWay, flowItem)) {\n            continue;\n        }\n        let timeOutput = new Date(Date.parse(roadWay.PBT));\n        data.push({\n            json: {\n                name: flowItem.TMC.DE,\n                speed: flowItem.CF[0].SU,\n                parent_name: roadWay.DE,\n                road_id: roadWay.LI,\n                tmc_id: flowItem.TMC.PC,\n                time: timeOutput.toLocaleString('de-DE', dateTimeOptions),\n                basetimestamp: timeOutput.toISOString().slice(0, 19).replace('T', ' '),\n                mid: roadWay.mid,\n                description: rules[roadWay.LI][flowItem.TMC.PC]\n            }\n        });\n    }\n}\n\nreturn data;\n"
      },
      "name": "Filter and transform data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        760,
        300
      ]
    },
    {
      "parameters": {
        "text": "={{$json[\"speed\"]}} km/h statt 50 km/h auf {{$json[\"description\"]}}. {{$json[\"time\"]}} Uhr üöóüí®\n#SpeederBot #RaserWiesbaden #WiesbadenSpeedWatch",
        "additionalFields": {}
      },
      "name": "Twitter",
      "type": "n8n-nodes-base.twitter",
      "typeVersion": 1,
      "position": [
        1490,
        530
      ],
      "credentials": {
        "twitterOAuth1Api": {
          "id": "5",
          "name": "WiesbadenRaser"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO speeders (mid, basetimestamp, speed, road_name, road_id, segment_id, segment_name, description) VALUES ('{{$json[\"mid\"]}}','{{$json[\"basetimestamp\"]}}',{{$json[\"speed\"]}},'{{$json[\"parent_name\"]}}','{{$json[\"road_id\"]}}',{{$json[\"tmc_id\"]}},'{{$json[\"name\"]}}','{{$json[\"description\"]}}');"
      },
      "name": "MySQL",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 1,
      "position": [
        1490,
        60
      ],
      "credentials": {
        "mySql": {
          "id": "7",
          "name": "Maria DB 10"
        }
      }
    }
  ],
  "connections": {
    "Here Traffic Flow Request": {
      "main": [
        [
          {
            "node": "Filter and transform data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Interval": {
      "main": [
        [
          {
            "node": "Here Traffic Flow Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter and transform data": {
      "main": [
        [
          {
            "node": "Twitter",
            "type": "main",
            "index": 0
          },
          {
            "node": "MySQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {},
  "id": 3
}
